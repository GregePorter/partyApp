<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="author" content="">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title></title>
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/trontastic/jquery-ui-1.10.4.custom.css">
    <link rel="stylesheet" type="text/css" href="css/jquery.timepicker.css">
    <style>
        body {
            padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
        }
        #bcontent {
            padding-top: 40px; 
        }
    </style> 
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries-->
    <!-- if lt IE 9
    script(src='https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js')
    script(src='https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js')
    -->
  </head>
  <body>
    <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
          <div class="navbar-header">
            <button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="/bdayApp" class="navbar-brand">partyApp</a>
          </div>
 
            <div class="collapse navbar-collapse">
 
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="/">Back to Home</a></li>
                    <li class="divider"></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Apps<b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            <li><a href="#"></a></li>
                        </ul>
                    </li>
                </ul>
            </div>
            <!--/.nav-collapse -->
        </div>
 
    </div>
    <div  class="container">
        
        <div id="bcontent" class="row">
            <div class="row">
                <div class="col-md-6">
                    <table id="grid"></table>
                </div>
                <div class="col-md-6">
                    <div id="detailArea"></div>
                </div>
            </div>
            
        </div><!-- /row -->

        <hr class="featurette-divider">
        <footer>
            <p class="pull-right"><a href="#">Back to top</a></p>
            <p>Â© 2014 </p>
        </footer>
 
    </div><!-- /container -->
<!-- Le javascript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.0/backbone-min.js"></script>
<script src="/js/grid.locale-en.js"></script>
<script src="/js/jquery.jqGrid.min.js"></script>
<script src="/js/jquery-ui-1.10.4.custom.js"></script>
<script src="/js/moment.min.js"></script>
<script src="/js/handlebars-1.0.rc.1.min.js"></script>
<script src="/js/jquery.timepicker.js"></script>
<script> 
 
$(function(){

//Model 
    var Person = Backbone.Model.extend({

        defaults: {
            name: "", //String
            age: null, //Number parsed from bdate field and calculated
            bdate: "", //String from jq DatePicker
            party_theme : "",
            party_date: "", //String (M)M/(D)D/YYYY
            party_time: "", //String HH:MM
            party_where: "" //String
        },
        initialize : function () {
            _.bindAll(this, 'updateAge')
            this.on('change:bdate', this.updateAge); 
            //model validstions 
        },
        updateAge : function () {
            var now = moment();
            this.set({age : now.diff(this.get('bdate'), 'years')});
        },
        //validate => triggers "invalid" and sets validationError with the message 
        validate: function(attrs, options){
            console.log("model.validate called!");

            var errors = [];
            if (!attrs.party_theme) {
                errors.push({name: 'party_theme', message: 'Please fill theme field.'});
            }
            if (!attrs.party_time) {
                errors.push({name: 'party_time', message: 'Please fill time field.'});
            }
            if (!moment(attrs.party_time, 'h:mm A').isValid()) {
                errors.push({name: 'party_time', message: 'Please enter a valid time.'});
            }
            if (moment().isAfter(attrs.party_date)){
                errors.push({name: 'party_date', message: 'Cannot start earlier than today.'});
            }
            if (!moment().isAfter(attrs.bdate)){
                errors.push({name: 'bdate', message: 'Enter a correct birthdate.'});
            }
            return errors.length > 0 ? errors : false;                  
        }
 
    });

    //Collection of Months of a year
    var Team = Backbone.Collection.extend({
        
        model: Person,
        
        initialize: function(models, options){
            console.log('Team collection init');
        }, 

        url: '/malformedData/impossible_birthday.json',

        //parse fired upon fetch.success()
        //returns team.json data in a collection of backbone models form
        parse: function(data, xhr) {   
            console.log('Team.Collection parse');
            return data;
        }

    });

    var TeamView = Backbone.View.extend({
        
        el: $("#grid"),
        
        //tagName: 'table', //tagName ???
        //id: 'grid',
        
        initialize: function(){
            console.log("TeamView init");
            this.render();
        },
        render: function() {

            $(this.el).jqGrid({
                data : this.collection.toJSON(), //populate grid at once 
                datatype: 'local',
                colNames:  [ 'id', 'Name', 'Age', 'Birthday', 'Party Date'],
                colModel : [
                            {name : 'id', index : 'id', key : true, resizeable : true, hidden: true},
                            {name : 'name', index : 'name', resizeable : true},
                            {name : 'age', index : 'age', resizeable : true},
                            {name : 'bdate', index : 'bdate', resizeable : true},
                            {name : 'party_date', index : 'party_date', resizeable : true}
                ],
                sortname: 'bdate, name asc',
                sortorder: "asc",
                caption : "Party App",
                height : "auto"
            });

            //Below code can be used to add rows individually if reqs change
            /*this.collection.each(function(model){
                $("#grid").jqGrid('addRowData', model.get('id'), model.toJSON()); 
                //this.$el.addRowData(model.get("id"), model.toJSON()); ???
            }); */

            return this; //enable chaining
        },
        events: {
            //jqGrid event "jqGridSelectRow" => callback returns rowid
            //show detailed personView  
            "jqGridSelectRow" : "showRowDetail"
        },
        showRowDetail: function(e, rowid, eventOriginal){
            console.log("rowid: " + rowid);
            console.log(this.collection.get(rowid));
            
            var aPerson = this.collection.get(rowid); 
            var personView = new PersonView({model: aPerson}); 
            $('#detailArea').html(personView.render().el);
        }

    });

    var myTeam = new Team(); //collection
    var teamView; // collection-view

    //ajax call on the collection
    myTeam.fetch({

        success: function(coll, response, options){
            var now = moment();
            console.log("fetch success");
            console.log(coll);

            //TODO: this should already be in team.json //we already have model.set.age on model-change
            coll.each( function (person) {

                //TODO: 3rd validation stage: Handle invalid logic in the data
                if(person.isValid()){
                    person.set({age : now.diff(person.get('bdate'), 'years')});
                }else{  
                    person.clear();
                }
                
            });

            teamView = new TeamView({collection: coll});
            //console.log(teamView.el);
            //$('#bcontent').html(teamView.el);
        },

        //TODO: validating JSON object based on default model data types ??? 

        error: function(coll, response, options){
            console.log("fetch error");
            console.log(response);
            var errors = [];
            if(response.readyState !== 4){
                 errors.push({message: 'The xhr request could not be completed!'});
            }
            if(response.status === 404){
                errors.push({message: 'Requested page not found. [404]'});
            } 
            if(response.status === 500){
                errors.push({message: 'Internal Server Error. [500]'});
            } 
            if((response.responseText !== "") && (coll.models.length === 0) ){
                errors.push({message: "Malformed JSON", responseText: response.responseText});
            }
            if(errors.length){
                _.each(errors, function(err, i){
                    
                    if(err.responseText){

                        console.log(err.responseText);

                        try{
                            JSON.parse(err.responseText);
                        }catch(e){
                            err.message += ": " + e.name;
                            err.message += " => " + e.message;
                            console.log(e.name);
                            console.log(e.message);
                        }
                    } 

                    alert(err.message);

                });
            }

        }

    });

    //PersonView to be dispalyed on each row-click     
    var PersonView = Backbone.View.extend({
        template: Handlebars.compile($('#options-template').html()), //template compiler
        initialize: function(){

            //clone the model upfront and change the reference to the original realModel
            //changes are happening on a cloned this.model
            //the original realModel gets changed on 'click .save' only
            this.realModel = this.model;
            this.model = this.realModel.clone();

            //re-render PersonView on any "change" on the Person model 
            //this.listenTo(this.model, 'change',  this.render);

            //listenTo 'invalid' or 'error' events triggered on this.model
            this.listenTo(this.model, 'invalid',  this.printInvalid); //print invalid errors on 'invalid'
            this.listenTo(this.model, 'error',  this.printError); // all other errors on 'error'

        },     
        render: function() {
            //console.log("PersonView rendered");
            //pass the Month model and compile this.template and put generated HTML in this.el 
            $(this.el).html(this.template(this.model.toJSON()));

            //initialize datepicker() and timepicker() 
            $("#date_input").attr("readonly", true).css("background", "white").datepicker({changeYear:true, changeMonth:true, yearRange:"1940:2120"});
            $("#time_input").timepicker({ 'step': 15, 'timeFormat': 'h:i A' });
            
            return this;//return context to enable chained calls 
        },
        events: {
            "click .type": "switchTemplate",
            "change":  "setClonedModel",
            "click .save":  "savePerson", 
            "click .cancel": "cancelChanges" 
        },
        //switches this.template based on radio selection
        //?? effects model => action: party ??
        switchTemplate : function (e) {
            var templateName = "#" + e.target.id + "-template";
            this.template = Handlebars.compile($(templateName).html());
            this.render();
        },
        //set cloned model on every field change on this view
        setClonedModel : function (event) {
            console.log("update triggered");
            
            //reset invalid messages and css classes
            this.$el.find(".form-group").removeClass("has-error");
            this.$el.find("span.help-block").text("");

            //Apply the change in the text-field to the cloned model
            var target = event.target;
            var change = {};
            change[target.name] = target.value;

            //By default model's validate method is called before save, but can also be called before set if {validate:true}
            //this._clonedModel.set(target.name , target.value, {validate:true});
            this.model.set(target.name , target.value, {validate:true});
            //this.updateRow();
           
        },
        //update jqGrid's row representing this model
        updateRow: function(){
            $("#grid").jqGrid('setRowData', this.model.get('id'), this.model.toJSON());
        },
        //faking save by triggering "change" and updating relevant row with jqGrid.setRowData()
        savePerson: function(e){
            e.preventDefault();  // preventing default submission..
            console.log("Saving person..");
            //if(this.model.isValid()){this.model.save();}
            //since we don't have a backend we're faking save with setting the original realModel
            this.realModel.set(this.model.attributes);
            //Apply changes on grid
            this.updateRow();  
            this.$el.empty();    
        },
        //Do nothing on model and clear the current view $el
        cancelChanges: function(e){
            e.preventDefault();  // preventing default submission..

            //empty the personView 
            this.$el.empty();

        },
        printError: function(model, errors){
            console.log("error on model"); //TODO: how to handle?????
        },
        printInvalid: function(model, errors){
            var self = this;
            _.each(errors, function(err, i){
                //TODO: overwite error messages for this specific view ???

                self.$el.find("input[name='" + err.name + "']").parents(".form-group").addClass("has-error");
                self.$el.find("input[name='" + err.name + "']").next().text(err.message);
                //alert(err.message); 
            });
        }
 
    });
    
});

</script> 

<script type="text/x-handlebars-template" id="options-template">
<div class="form-group">
    <div class="radio">
        <label class="col-md-5 col-md-offset-1 control-label">
            <input type="radio" class="type" name="action" id="party" value="party">
            Add or Edit Party Info
        </label>
    </div>
    <div class="radio">
        <label class="col-md-5 col-md-offset-1 control-label">
            <input type="radio" class="type" name="action" id="birthday" value="birthday">
             Add or Edit Birthday Info
        </label>
    </div>
</div>
</script>

<script type="text/x-handlebars-template" id="party-template">
<form class="form-horizontal" role="form">
  <div class="form-group">
    <label for="party_theme" class="col-md-2 col-md-offset-1 control-label">Party Theme</label>
    <div class="col-md-4">
      <input type="text" class="form-control" name="party_theme" value="{{party_theme}}" placeholder="Party Theme..">
      <span class="help-block"></span>
    </div>
  </div>
  <div class="form-group">
    <label for="party_date" class="col-md-2 col-md-offset-1 control-label">Party Date</label>
    <div class="col-md-4">
      <input type="text" class="form-control" id="date_input" name="party_date" value="{{party_date}}" placeholder="Party Date">
      <span class="help-block"></span>
    </div>
  </div>
  <div class="form-group">
    <label for="party_time" class="col-md-2 col-md-offset-1 control-label">Starts at</label>
    <div class="col-md-4">
      <input type="text" class="form-control" id="time_input" name="party_time" value="{{party_time}}" placeholder="hh:mm A">
      <span class="help-block"></span>
    </div>
  </div>

  <div class="form-group">
    <div class="col-md-2 col-md-offset-2">
      <button type="submit" class="btn btn-default save">Save</button>
    </div>
    <div class="col-md-2 col-md-offset-2">
      <button class="btn btn-default cancel">Cancel</button>
    </div>
  </div>
</form>
</script>

<script type="text/x-handlebars-template" id="birthday-template">
<form class="form-horizontal" role="form">
  <div class="form-group">
    <label for="bdate" class="col-md-2 col-md-offset-1 control-label">Birthdate</label>
    <div class="col-md-4">
      <input type="text" class="form-control" id="date_input" name="bdate" value="{{bdate}}" placeholder="Birthdate..">
      <span class="help-block"></span>
    </div>
  </div>

  <div class="form-group">
    <div class="col-md-2 col-md-offset-2">
      <button type="submit" class="btn btn-default save">Save</button>
    </div>
    <div class="col-md-2 col-md-offset-2">
      <button class="btn btn-default cancel">Cancel</button>
    </div>
  </div>
</form>
</script>
</body>
</html>